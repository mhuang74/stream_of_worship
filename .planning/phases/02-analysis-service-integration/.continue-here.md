---
phase: 02-analysis-service-integration
plan: ready-to-execute
total_plans: 3
status: planning_complete
last_updated: 2026-02-13T07:29:53.681Z
---

<current_state>
Phase 2: Analysis Service Integration - Planning complete, ready to execute.

**Current Position:**
- All 3 plans have been created and VERIFIED (passed after 1 revision)
- Wave structure: Wave 1 (Plans 01, 03 in parallel), Wave 2 (Plan 02)
- No code execution has started yet

**Plans Ready:**
- Plan 01: Qwen3Client HTTP client + use_qwen3 flag (2 tasks, 3 files)
- Plan 02: LRC worker integration with dual-path logic (2 tasks, 2 files)
- Plan 03: Docker compose configuration (1 task, 1 file)

**Issues Addressed in Revision:**
1. Fixed API contract mismatch (output_format → format, added lrc_content field)
2. Clarified R2 URL construction pattern (s3://{SOW_R2_BUCKET}/audio/{hash_prefix}.mp3)
</current_state>

<completed_work>

- **Phase 1 Complete**: Qwen3 Service Foundation (4 plans, 100% complete)
  - FastAPI microservice with Qwen3ForcedAligner wrapper
  - POST /api/v1/align endpoint (LRC/JSON output)
  - Health check endpoint
  - Docker configuration with 8GB/4CPU limits
  - Complete README documentation

- **Phase 2 Planning Complete**: All 3 plans created and verified
  - Plan 01: Qwen3Client HTTP client implementation
    - Task 1: Create qwen3_client.py with AlignRequest/AlignResponse matching Phase 1 API
    - Task 2: Add use_qwen3 flag to LrcOptions dataclass
  - Plan 02: LRC worker integration
    - Task 1: Add SOW_QWEN3_BASE_URL to settings
    - Task 2: Integrate Qwen3 refinement with dual-path logic
      - YouTube path: skip Qwen3 (transcript timestamps already accurate)
      - Whisper path: use Qwen3 refinement when use_qwen3=True
  - Plan 03: Docker compose configuration
    - Task 1: Add qwen3 service to docker-compose.yml with networking

</completed_work>

<remaining_work>

**Phase 2 Execution (not started):**
- Execute Plan 01 (Wave 1): Qwen3Client + use_qwen3 flag
- Execute Plan 03 (Wave 1, in parallel): Docker compose config
- Execute Plan 02 (Wave 2): LRC worker integration

**Remaining Phases (after Phase 2):**
- Phase 3: Fallback & Reliability
- Phase 4: Testing & Validation
- Phase 5: Performance & Production Readiness

</remaining_work>

<decisions_made>

- **Phase 1** (Complete):
  - Separate Docker service for Qwen3 to isolate PyTorch dependencies
  - Model path: /models/qwen3-forced-aligner (volume mount)
  - qwen-asr version: >=0.0.6 (latest on PyPI)

- **Phase 2** (Planned):
  - R2 URL format: s3://{SOW_R2_BUCKET}/audio/{hash_prefix}.mp3
  - Qwen3 service reachable at http://qwen3:8000 on Docker network
  - YouTube path skips Qwen3 (transcript timestamps accurate)
  - Whisper path uses Qwen3 refinement
  - API contract must match Phase 1 service exactly

</decisions_made>

<blockers>

None. All plans verified and ready to execute.

</blockers>

<context>

**Big Picture:**
We're integrating the Qwen3 Alignment Service (Phase 1) into the existing Analysis Service's LRC generation pipeline. The goal is to refine timestamp accuracy for Whisper-transcribed Chinese audio.

**Integration Approach:**
- Create HTTP client in Analysis Service to call Qwen3 align endpoint
- Modify LRC worker to support dual paths:
  - YouTube: transcript → LLM fix-up → LRC (skip Qwen3)
  - Whisper: transcription → LLM fix-up → Qwen3 refinement → LRC
- Add use_qwen3 flag to control Qwen3 usage
- Wire both services together in docker-compose

**Key Technical Details:**
- Qwen3 API at http://qwen3:8000/api/v1/align
- Accepts audio_url (s3:// format) and lyrics_text
- Returns AlignResponse with lrc_content field
- Audio URL needs to be constructed from hash_prefix using R2 settings

**Next Action:**
Execute Phase 2 with `/gsd:execute-phase 02-analysis-service-integration`

</context>

<next_action>

Start Phase 2 execution with:
```bash
/gsd:execute-phase 02-analysis-service-integration
```

This will run all 3 plans in Wave 1 (01, 03) in parallel, then Wave 2 (02).

</next_action>
