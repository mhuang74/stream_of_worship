version: '3.8'

services:
  analysis:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - TARGETPLATFORM=${TARGETPLATFORM:-linux/amd64}
    ports:
      - "8000:8000"
    environment:
      - R2_BUCKET=${R2_BUCKET:-sow-audio}
      - R2_ENDPOINT_URL=${R2_ENDPOINT_URL}
      - SOW_R2_ACCESS_KEY_ID=${SOW_R2_ACCESS_KEY_ID}
      - SOW_R2_SECRET_ACCESS_KEY=${SOW_R2_SECRET_ACCESS_KEY}
      - ANALYSIS_API_KEY=${ANALYSIS_API_KEY}
      - MAX_CONCURRENT_JOBS=${MAX_CONCURRENT_JOBS:-2}
      - DEMUCS_DEVICE=${DEMUCS_DEVICE:-cpu}
      - NATTEN_LOG_LEVEL=error
    volumes:
      - analysis-cache:/cache
    deploy:
      resources:
        reservations:
          devices:
            # GPU block requires nvidia-container-toolkit.
            # For CPU-only fallback, remove the entire deploy.resources block.
            - driver: nvidia
              count: 1
              capabilities: [ gpu ]

volumes:
  analysis-cache:
